<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ë”ë³´ë“œ - ëª¨ì˜ íˆ¬ì ëŒ€íšŒ</title>
    <!-- Theme JS (load early to prevent flash) -->
    <script src="/static/common/theme.js"></script>
    <style>
        /* Theme CSS Variables */
        :root, [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #222;
            --bg-hover: #333;
            --text-primary: #fff;
            --text-secondary: #e0e0e0;
            --text-muted: #888;
            --border-primary: #333;
            --border-secondary: #222;
            --accent-primary: #00d4aa;
            --accent-hover: #00f5c4;
            --price-up: #ef5350;
            --price-down: #26a69a;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --bg-hover: #ddd;
            --text-primary: #1a1a1a;
            --text-secondary: #333;
            --text-muted: #666;
            --border-primary: #ddd;
            --border-secondary: #e5e5e5;
            --accent-primary: #00a884;
            --accent-hover: #00c49a;
            --price-up: #d32f2f;
            --price-down: #00897b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav a {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s;
        }

        .nav a:hover, .nav a.active {
            color: var(--text-primary);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: var(--text-muted);
        }

        /* Multiple leaderboards grid */
        .leaderboards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 2rem;
        }

        .competition-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-primary);
        }

        .competition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .competition-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .competition-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .competition-status.active {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent-primary);
        }

        .competition-status.ended {
            background: rgba(136, 136, 136, 0.2);
            color: var(--text-muted);
        }

        .competition-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: bold;
        }

        .leaderboard-table {
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
        }

        .leaderboard-header {
            display: grid;
            grid-template-columns: 45px 1fr 100px 100px 55px 70px;
            padding: 0.75rem 1rem;
            background: var(--bg-hover);
            font-weight: bold;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .leaderboard-row {
            display: grid;
            grid-template-columns: 45px 1fr 100px 100px 55px 70px;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-primary);
            transition: background 0.2s;
            font-size: 0.85rem;
        }

        .leaderboard-row:hover {
            background: var(--bg-hover);
        }

        .leaderboard-row:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .medal {
            font-size: 1.5rem;
        }

        .username {
            font-weight: 500;
        }

        .profit-rate {
            font-weight: bold;
        }

        .profit-rate.positive {
            color: var(--price-up);
        }

        .profit-rate.negative {
            color: var(--price-down);
        }

        .profit-rate.zero {
            color: var(--text-muted);
        }

        .total-asset, .balance {
            text-align: right;
        }

        .my-rank {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--accent-primary);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .refresh-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .refresh-btn:hover {
            background: var(--bg-hover);
        }

        .update-time {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-left: 1rem;
        }

        @media (max-width: 768px) {
            .leaderboards-grid {
                grid-template-columns: 1fr;
            }

            .leaderboard-header,
            .leaderboard-row {
                grid-template-columns: 40px 1fr 90px 70px;
            }

            .total-asset, .trade-count {
                display: none;
            }

            .competition-stats {
                gap: 1rem;
            }
        }

        .controls-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">Upbit Trading Competition</div>
        <nav class="nav">
            <a href="/competition">ëŒ€íšŒ</a>
            <a href="/competition/trading">íŠ¸ë ˆì´ë”©</a>
            <a href="/competition/leaderboard" class="active">ë¦¬ë”ë³´ë“œ</a>
            <a href="/docs">API ë¬¸ì„œ</a>
            <a href="/">ì‹œì„¸ ëŒ€ì‹œë³´ë“œ</a>
            <a href="/admin" id="admin-link" style="display: none; color: #ef5350;">ê´€ë¦¬ì</a>
            <span id="theme-toggle-container"></span>
        </nav>
    </header>

    <div class="container">
        <div class="page-header">
            <h1>ë¦¬ë”ë³´ë“œ</h1>
            <p>ëŒ€íšŒë³„ ì‹¤ì‹œê°„ ìˆœìœ„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="controls-bar">
            <button class="refresh-btn" onclick="loadAllLeaderboards()">ìƒˆë¡œê³ ì¹¨</button>
            <span id="update-time" class="update-time"></span>
        </div>

        <div id="leaderboards-container" class="leaderboards-grid">
            <div class="loading" style="text-align: center; padding: 3rem; grid-column: 1 / -1;">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <script src="/static/common/api.js"></script>
    <script>
        let competitions = [];
        let currentPrices = {};
        let ws = null;

        // ì§€ì› ì½”ì¸ ëª©ë¡
        const CODES = ['KRW-BTC', 'KRW-ETH', 'KRW-XRP', 'KRW-SOL', 'KRW-DOGE',
                       'KRW-ADA', 'KRW-AVAX', 'KRW-DOT', 'KRW-LINK', 'KRW-MATIC'];

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            // WebSocket ì—°ê²°
            connectWebSocket();

            // ì´ˆê¸° ì‹œì„¸ ë¡œë“œ
            await loadInitialPrices();

            // ëª¨ë“  ë¦¬ë”ë³´ë“œ ë¡œë“œ
            await loadAllLeaderboards();

            // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
            setInterval(loadAllLeaderboards, 30000);
        });

        // ì´ˆê¸° ì‹œì„¸ ë¡œë“œ
        async function loadInitialPrices() {
            try {
                const pricePromises = CODES.map(async (code) => {
                    try {
                        const data = await tradingAPI.getLatestPrice(code);
                        if (data && data.trade_price) {
                            currentPrices[code] = data.trade_price;
                        }
                    } catch (e) {
                        console.warn(`Failed to load price for ${code}:`, e);
                    }
                });
                await Promise.all(pricePromises);
                console.log('Initial prices loaded:', Object.keys(currentPrices).length, 'coins');
            } catch (error) {
                console.error('Failed to load initial prices:', error);
            }
        }

        // WebSocket ì—°ê²° (ì‹œì„¸ìš©)
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                ws.send(JSON.stringify({ subscribe: CODES }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.code && data.trade_price) {
                    currentPrices[data.code] = data.trade_price;
                }
            };

            ws.onclose = () => {
                setTimeout(connectWebSocket, 1000);
            };
        }

        // ëª¨ë“  ëŒ€íšŒ ë¦¬ë”ë³´ë“œ ë¡œë“œ
        async function loadAllLeaderboards() {
            const container = document.getElementById('leaderboards-container');

            try {
                // ëª¨ë“  ëŒ€íšŒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const allComps = await tradingAPI.getCompetitions();

                // active ë˜ëŠ” ended ìƒíƒœì˜ ëŒ€íšŒë§Œ í•„í„° (ì°¸ê°€ìê°€ ìˆì„ ìˆ˜ ìˆëŠ” ëŒ€íšŒ)
                // active ìš°ì„ , ê·¸ ë‹¤ìŒ endedë¥¼ ì‹œì‘ì‹œê°„ ì—­ìˆœìœ¼ë¡œ
                const activeComps = allComps.filter(c => c.status === 'active')
                    .sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
                const endedComps = allComps.filter(c => c.status === 'ended')
                    .sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

                competitions = [...activeComps, ...endedComps];

                if (competitions.length === 0) {
                    container.innerHTML = '<div class="no-data" style="text-align: center; padding: 3rem; grid-column: 1 / -1;">í‘œì‹œí•  ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                // ê° ëŒ€íšŒì˜ ë¦¬ë”ë³´ë“œë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œ
                const leaderboardPromises = competitions.map(async (comp) => {
                    try {
                        const leaderboard = await tradingAPI.getLeaderboard(comp.id, currentPrices);
                        return { competition: comp, leaderboard };
                    } catch (e) {
                        console.error(`Failed to load leaderboard for ${comp.name}:`, e);
                        return { competition: comp, leaderboard: [] };
                    }
                });

                const results = await Promise.all(leaderboardPromises);

                // HTML ë Œë”ë§
                container.innerHTML = results.map(({ competition, leaderboard }) => {
                    return renderCompetitionSection(competition, leaderboard);
                }).join('');

                // ì—…ë°ì´íŠ¸ ì‹œê°„
                document.getElementById('update-time').textContent =
                    `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR', { timeZone: 'Asia/Seoul' })}`;

            } catch (error) {
                console.error('Failed to load leaderboards:', error);
                container.innerHTML = '<div class="no-data" style="text-align: center; padding: 3rem; grid-column: 1 / -1;">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ëŒ€íšŒ ì„¹ì…˜ ë Œë”ë§
        function renderCompetitionSection(competition, leaderboard) {
            const statusText = competition.status === 'active' ? 'ì§„í–‰ ì¤‘' :
                              competition.status === 'pending' ? 'ì˜ˆì •' : 'ì¢…ë£Œ';
            const statusClass = competition.status === 'active' ? 'active' : 'ended';

            const startDate = new Date(competition.start_time).toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', month: 'short', day: 'numeric' });
            const endDate = new Date(competition.end_time).toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', month: 'short', day: 'numeric' });

            let leaderboardHtml;
            if (leaderboard.length === 0) {
                leaderboardHtml = '<div class="no-data" style="text-align: center; padding: 2rem; color: #888;">ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                leaderboardHtml = `
                    <div class="leaderboard-table">
                        <div class="leaderboard-header">
                            <span>ìˆœìœ„</span>
                            <span>ì°¸ê°€ì</span>
                            <span class="total-asset" style="text-align: right;">ì´ ìì‚°</span>
                            <span style="text-align: right;">í˜„ê¸ˆ</span>
                            <span class="trade-count" style="text-align: right;">ê±°ë˜</span>
                            <span style="text-align: right;">ìˆ˜ìµë¥ </span>
                        </div>
                        ${leaderboard.map(entry => renderLeaderboardRow(entry)).join('')}
                    </div>
                `;
            }

            return `
                <div class="competition-section">
                    <div class="competition-header">
                        <span class="competition-title">${competition.name}</span>
                        <span class="competition-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="competition-stats">
                        <div class="stat-item">
                            <div class="stat-label">ì°¸ê°€ì</div>
                            <div class="stat-value">${competition.participant_count}ëª…</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ì‹œì‘ ìê¸ˆ</div>
                            <div class="stat-value">${formatNumber(competition.initial_balance)}ì›</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ê¸°ê°„</div>
                            <div class="stat-value">${startDate} ~ ${endDate}</div>
                        </div>
                    </div>
                    ${leaderboardHtml}
                </div>
            `;
        }

        // ë¦¬ë”ë³´ë“œ í–‰ ë Œë”ë§
        function renderLeaderboardRow(entry) {
            const rankClass = entry.rank <= 3 ? `rank-${entry.rank}` : '';
            const medal = entry.rank === 1 ? 'ğŸ¥‡' : entry.rank === 2 ? 'ğŸ¥ˆ' : entry.rank === 3 ? 'ğŸ¥‰' : '';
            const profitClass = entry.profit_rate > 0 ? 'positive' : entry.profit_rate < 0 ? 'negative' : 'zero';
            const profitSign = entry.profit_rate > 0 ? '+' : '';

            return `
                <div class="leaderboard-row">
                    <span class="rank ${rankClass}">
                        ${medal ? `<span class="medal">${medal}</span>` : ''}
                        ${entry.rank}
                    </span>
                    <span class="username">${entry.username || 'ìµëª…'}</span>
                    <span class="total-asset" style="text-align: right;">${formatNumber(entry.total_asset)}ì›</span>
                    <span class="balance" style="text-align: right;">${formatNumber(entry.balance)}ì›</span>
                    <span class="trade-count" style="text-align: right;">${entry.trade_count || 0}íšŒ</span>
                    <span class="profit-rate ${profitClass}" style="text-align: right;">${profitSign}${entry.profit_rate.toFixed(2)}%</span>
                </div>
            `;
        }

        // ìˆ«ì í¬ë§·
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return Math.round(num).toLocaleString('ko-KR');
        }
    </script>
</body>
</html>
