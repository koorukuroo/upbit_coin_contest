<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>참가자 상세 - 관리자</title>
    <!-- Theme JS (load early to prevent flash) -->
    <script src="/static/common/theme.js"></script>
    <style>
        /* Theme CSS Variables */
        :root, [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #222;
            --bg-hover: #2a2a2a;
            --text-primary: #fff;
            --text-secondary: #e0e0e0;
            --text-muted: #888;
            --border-primary: #333;
            --border-secondary: #222;
            --accent-primary: #00d4aa;
            --accent-hover: #00f5c4;
            --danger: #ef5350;
            --warning: #ffa726;
            --success: #66bb6a;
            --price-up: #ef5350;
            --price-down: #26a69a;
            --info: #42a5f5;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --bg-hover: #ddd;
            --text-primary: #1a1a1a;
            --text-secondary: #333;
            --text-muted: #666;
            --border-primary: #ddd;
            --border-secondary: #e5e5e5;
            --accent-primary: #00a884;
            --accent-hover: #00c49a;
            --danger: #d32f2f;
            --warning: #f57c00;
            --success: #388e3c;
            --price-up: #d32f2f;
            --price-down: #00897b;
            --info: #1976d2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--danger);
        }

        .nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav a {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s;
        }

        .nav a:hover {
            color: var(--text-primary);
        }

        .btn-logout {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }

        .btn-logout:hover {
            opacity: 0.9;
        }

        .user-info-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .breadcrumb {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* User Profile Section */
        .profile-section {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-primary);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 2rem;
            align-items: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }

        .profile-info h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .profile-info .email {
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .profile-info .meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .profile-stats {
            display: flex;
            gap: 2rem;
        }

        .profile-stat {
            text-align: center;
            padding: 1rem 1.5rem;
            background: var(--bg-primary);
            border-radius: 12px;
        }

        .profile-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .profile-stat .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .profit-positive { color: var(--price-up); }
        .profit-negative { color: var(--price-down); }
        .profit-zero { color: var(--text-muted); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--border-primary);
        }

        .stat-card h3 {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-card .sub {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-primary);
            padding-bottom: 0.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border-radius: 8px 8px 0 0;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            position: relative;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .tab.active {
            color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-primary);
        }

        .tab .count {
            background: var(--bg-tertiary);
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .tab.active .count {
            background: var(--accent-primary);
            color: white;
        }

        /* Tab Panels */
        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Section */
        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .section-header h2 {
            font-size: 1rem;
            font-weight: 600;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Filter */
        .filter-group {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid var(--border-primary);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
        }

        .table th {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tr:hover {
            background: var(--bg-hover);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        /* Order/Trade specific */
        .side-buy {
            color: var(--price-up);
            font-weight: 600;
        }

        .side-sell {
            color: var(--price-down);
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-filled {
            background: rgba(102, 187, 106, 0.2);
            color: var(--success);
        }

        .status-pending {
            background: rgba(255, 167, 38, 0.2);
            color: var(--warning);
        }

        .status-cancelled {
            background: rgba(136, 136, 136, 0.2);
            color: var(--text-muted);
        }

        .status-partial {
            background: rgba(66, 165, 245, 0.2);
            color: var(--info);
        }

        /* Position Card */
        .positions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        .position-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--border-primary);
        }

        .position-card .code {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .position-card .code .coin-icon {
            width: 28px;
            height: 28px;
            background: var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .position-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .position-detail {
            display: flex;
            flex-direction: column;
        }

        .position-detail .label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .position-detail .value {
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-primary);
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-primary);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--bg-hover);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-primary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .profile-section {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .profile-avatar {
                margin: 0 auto;
            }

            .profile-info .meta {
                justify-content: center;
            }

            .profile-stats {
                justify-content: center;
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .table th, .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">Admin Panel</div>
        <nav class="nav">
            <a href="/admin">대시보드</a>
            <a href="/competition">대회</a>
            <a href="/docs">API 문서</a>
            <a href="/">시세 대시보드</a>
            <span id="theme-toggle-container"></span>
            <div class="user-info-header">
                <span id="user-email"></span>
                <button class="btn-logout" onclick="logout()">로그아웃</button>
            </div>
        </nav>
    </header>

    <div class="container">
        <div class="breadcrumb">
            <a href="/admin">관리자</a>
            <span>/</span>
            <a href="#" id="breadcrumb-competition">대회</a>
            <span>/</span>
            <span id="breadcrumb-user">참가자</span>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>로딩 중...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Profile Section -->
            <div class="profile-section">
                <div class="profile-avatar" id="user-avatar">?</div>
                <div class="profile-info">
                    <h1 id="user-name">사용자</h1>
                    <div class="email" id="user-email">-</div>
                    <div class="meta">
                        <span>참가일: <span id="join-date">-</span></span>
                        <span>대회: <span id="competition-name">-</span></span>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="value" id="profit-rate">-</div>
                        <div class="label">수익률</div>
                    </div>
                    <div class="profile-stat">
                        <div class="value" id="total-asset">-</div>
                        <div class="label">총 자산</div>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>KRW 잔고</h3>
                    <div class="value" id="stat-balance">-</div>
                </div>
                <div class="stat-card">
                    <h3>코인 평가액</h3>
                    <div class="value" id="stat-coin-value">-</div>
                </div>
                <div class="stat-card">
                    <h3>총 주문</h3>
                    <div class="value" id="stat-orders">-</div>
                </div>
                <div class="stat-card">
                    <h3>총 거래</h3>
                    <div class="value" id="stat-trades">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="positions">
                    보유 자산
                    <span class="count" id="position-count">0</span>
                </button>
                <button class="tab" data-tab="orders">
                    주문 내역
                    <span class="count" id="order-count">0</span>
                </button>
                <button class="tab" data-tab="trades">
                    거래 내역
                    <span class="count" id="trade-count">0</span>
                </button>
            </div>

            <!-- Positions Panel -->
            <div class="tab-panel active" id="panel-positions">
                <div class="section">
                    <div class="section-header">
                        <h2>보유 자산</h2>
                    </div>
                    <div class="positions-grid" id="positions-grid">
                        <div class="empty-state">보유 중인 자산이 없습니다.</div>
                    </div>
                </div>
            </div>

            <!-- Orders Panel -->
            <div class="tab-panel" id="panel-orders">
                <div class="section">
                    <div class="section-header">
                        <h2>주문 내역</h2>
                        <div class="section-actions">
                            <div class="filter-group">
                                <button class="filter-btn active" data-status="">전체</button>
                                <button class="filter-btn" data-status="pending">대기</button>
                                <button class="filter-btn" data-status="filled">체결</button>
                                <button class="filter-btn" data-status="cancelled">취소</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>시간</th>
                                    <th>코인</th>
                                    <th>구분</th>
                                    <th>유형</th>
                                    <th style="text-align: right;">주문가</th>
                                    <th style="text-align: right;">수량</th>
                                    <th style="text-align: right;">체결가</th>
                                    <th style="text-align: right;">체결수량</th>
                                    <th style="text-align: right;">수수료</th>
                                    <th>상태</th>
                                </tr>
                            </thead>
                            <tbody id="orders-body">
                                <tr><td colspan="10" class="loading">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="orders-pagination">
                        <button id="orders-prev" disabled>이전</button>
                        <span class="page-info" id="orders-page-info">1 / 1</span>
                        <button id="orders-next" disabled>다음</button>
                    </div>
                </div>
            </div>

            <!-- Trades Panel -->
            <div class="tab-panel" id="panel-trades">
                <div class="section">
                    <div class="section-header">
                        <h2>거래 내역</h2>
                        <div class="section-actions">
                            <button class="btn btn-secondary" onclick="exportTrades()">CSV 다운로드</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>시간</th>
                                    <th>코인</th>
                                    <th>구분</th>
                                    <th style="text-align: right;">체결가</th>
                                    <th style="text-align: right;">수량</th>
                                    <th style="text-align: right;">거래금액</th>
                                    <th style="text-align: right;">수수료</th>
                                </tr>
                            </thead>
                            <tbody id="trades-body">
                                <tr><td colspan="7" class="loading">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="trades-pagination">
                        <button id="trades-prev" disabled>이전</button>
                        <span class="page-info" id="trades-page-info">1 / 1</span>
                        <button id="trades-next" disabled>다음</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clerk SDK -->
    <!-- TODO: Replace YOUR_CLERK_PUBLISHABLE_KEY with your Clerk publishable key from https://clerk.com -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="YOUR_CLERK_PUBLISHABLE_KEY"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        type="text/javascript"
    ></script>

    <script src="/static/common/api.js"></script>
    <script>
        let participantId = null;
        let participantData = null;
        let currentPrices = {};

        // Pagination state
        let ordersPage = 0;
        let ordersTotal = 0;
        let ordersStatus = '';
        const ordersLimit = 20;

        let tradesPage = 0;
        let tradesTotal = 0;
        const tradesLimit = 20;

        const CODES = ['KRW-BTC', 'KRW-ETH', 'KRW-XRP', 'KRW-SOL', 'KRW-DOGE',
                       'KRW-ADA', 'KRW-AVAX', 'KRW-DOT', 'KRW-LINK', 'KRW-MATIC'];

        // Clerk 로드 대기
        async function waitForClerk() {
            return new Promise((resolve) => {
                if (window.Clerk) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.Clerk) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        resolve();
                    }, 5000);
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await waitForClerk();

            // 현재 로그인한 사용자 이메일 표시
            if (window.Clerk && window.Clerk.user) {
                const email = window.Clerk.user.primaryEmailAddress?.emailAddress;
                if (email) {
                    document.getElementById('user-email').textContent = email;
                }

                // 먼저 register를 호출하여 이메일 업데이트 (기존 @clerk.dev 이메일 수정)
                const token = await window.Clerk.session.getToken();
                if (token) {
                    await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
            }

            // Get participant ID from URL
            const pathParts = window.location.pathname.split('/');
            participantId = pathParts[pathParts.length - 1];

            if (!participantId) {
                alert('참가자 ID가 없습니다.');
                window.location.href = '/admin';
                return;
            }

            // Connect WebSocket for prices
            connectWebSocket();

            // Setup tabs
            setupTabs();

            // Setup filters
            setupFilters();

            // Setup pagination
            setupPagination();

            // Load data
            await loadParticipantData();
        });

        // 로그아웃
        async function logout() {
            if (window.Clerk) {
                await window.Clerk.signOut();
                window.location.href = '/competition';
            }
        }

        // WebSocket for prices
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                ws.send(JSON.stringify({ subscribe: CODES }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.code && data.trade_price) {
                    currentPrices[data.code] = data.trade_price;
                    updatePositionValues();
                }
            };

            ws.onclose = () => {
                setTimeout(connectWebSocket, 2000);
            };
        }

        // Setup tabs
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;

                    // Update tab buttons
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update panels
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(`panel-${tabId}`).classList.add('active');

                    // Load data if needed
                    if (tabId === 'orders' && ordersTotal === 0) {
                        loadOrders();
                    } else if (tabId === 'trades' && tradesTotal === 0) {
                        loadTrades();
                    }
                });
            });
        }

        // Setup filters
        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    ordersStatus = btn.dataset.status;
                    ordersPage = 0;
                    loadOrders();
                });
            });
        }

        // Setup pagination
        function setupPagination() {
            document.getElementById('orders-prev').addEventListener('click', () => {
                if (ordersPage > 0) {
                    ordersPage--;
                    loadOrders();
                }
            });

            document.getElementById('orders-next').addEventListener('click', () => {
                if ((ordersPage + 1) * ordersLimit < ordersTotal) {
                    ordersPage++;
                    loadOrders();
                }
            });

            document.getElementById('trades-prev').addEventListener('click', () => {
                if (tradesPage > 0) {
                    tradesPage--;
                    loadTrades();
                }
            });

            document.getElementById('trades-next').addEventListener('click', () => {
                if ((tradesPage + 1) * tradesLimit < tradesTotal) {
                    tradesPage++;
                    loadTrades();
                }
            });
        }

        // Load participant data
        async function loadParticipantData() {
            try {
                participantData = await adminAPI.getParticipant(participantId);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                renderParticipantData();
                loadOrders();
                loadTrades();

            } catch (error) {
                console.error('Error:', error);
                alert('참가자 정보를 불러올 수 없습니다. 관리자 권한이 필요합니다.');
                window.location.href = '/admin';
            }
        }

        // Render participant data
        function renderParticipantData() {
            const { participant, user, competition, positions, stats } = participantData;

            // Breadcrumb
            document.getElementById('breadcrumb-competition').href = `/admin/competitions/${competition.id}`;
            document.getElementById('breadcrumb-competition').textContent = competition.name;
            document.getElementById('breadcrumb-user').textContent = user.email;

            // Avatar
            const initial = (user.username || user.email)[0].toUpperCase();
            document.getElementById('user-avatar').textContent = initial;

            // User info
            document.getElementById('user-name').textContent = user.username || user.email.split('@')[0];
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('join-date').textContent = new Date(participant.joined_at).toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' });
            document.getElementById('competition-name').textContent = competition.name;

            // Stats
            document.getElementById('stat-balance').textContent = formatNumber(participant.balance) + '원';
            document.getElementById('stat-orders').textContent = stats.order_count.toLocaleString();
            document.getElementById('stat-trades').textContent = stats.trade_count.toLocaleString();
            document.getElementById('order-count').textContent = stats.order_count;
            document.getElementById('trade-count').textContent = stats.trade_count;

            // Positions
            renderPositions(positions, competition.initial_balance);
        }

        // Render positions
        function renderPositions(positions, initialBalance) {
            const grid = document.getElementById('positions-grid');
            document.getElementById('position-count').textContent = positions.length;

            if (positions.length === 0) {
                grid.innerHTML = '<div class="empty-state">보유 중인 자산이 없습니다.</div>';
                updateTotalAsset(participantData.participant.balance, 0, initialBalance);
                return;
            }

            let coinValue = 0;
            grid.innerHTML = positions.map(pos => {
                const currentPrice = currentPrices[pos.code] || pos.avg_buy_price;
                const value = pos.quantity * currentPrice;
                const profit = ((currentPrice - pos.avg_buy_price) / pos.avg_buy_price * 100);
                const profitClass = profit > 0 ? 'profit-positive' : profit < 0 ? 'profit-negative' : '';
                coinValue += value;

                const coinSymbol = pos.code.replace('KRW-', '');

                return `
                    <div class="position-card">
                        <div class="code">
                            <span class="coin-icon">${coinSymbol.substring(0, 2)}</span>
                            ${pos.code}
                        </div>
                        <div class="position-details">
                            <div class="position-detail">
                                <span class="label">보유수량</span>
                                <span class="value">${formatQuantity(pos.quantity)}</span>
                            </div>
                            <div class="position-detail">
                                <span class="label">평균단가</span>
                                <span class="value">${formatNumber(pos.avg_buy_price)}원</span>
                            </div>
                            <div class="position-detail">
                                <span class="label">현재가</span>
                                <span class="value">${formatNumber(currentPrice)}원</span>
                            </div>
                            <div class="position-detail">
                                <span class="label">평가손익</span>
                                <span class="value ${profitClass}">${profit >= 0 ? '+' : ''}${profit.toFixed(2)}%</span>
                            </div>
                            <div class="position-detail" style="grid-column: span 2;">
                                <span class="label">평가금액</span>
                                <span class="value">${formatNumber(value)}원</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('stat-coin-value').textContent = formatNumber(coinValue) + '원';
            updateTotalAsset(participantData.participant.balance, coinValue, initialBalance);
        }

        // Update position values with new prices
        function updatePositionValues() {
            if (!participantData) return;
            renderPositions(participantData.positions, participantData.competition.initial_balance);
        }

        // Update total asset and profit rate
        function updateTotalAsset(balance, coinValue, initialBalance) {
            const totalAsset = balance + coinValue;
            const profitRate = (totalAsset - initialBalance) / initialBalance * 100;
            const profitClass = profitRate > 0 ? 'profit-positive' : profitRate < 0 ? 'profit-negative' : 'profit-zero';

            document.getElementById('total-asset').textContent = formatNumber(totalAsset) + '원';
            document.getElementById('profit-rate').textContent = (profitRate >= 0 ? '+' : '') + profitRate.toFixed(2) + '%';
            document.getElementById('profit-rate').className = `value ${profitClass}`;
        }

        // Load orders
        async function loadOrders() {
            const tbody = document.getElementById('orders-body');
            tbody.innerHTML = '<tr><td colspan="10" class="loading">로딩 중...</td></tr>';

            try {
                const data = await adminAPI.getParticipantOrders(participantId, {
                    status: ordersStatus,
                    limit: ordersLimit,
                    offset: ordersPage * ordersLimit
                });
                ordersTotal = data.total;

                if (data.orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="empty-state">주문 내역이 없습니다.</td></tr>';
                } else {
                    tbody.innerHTML = data.orders.map(order => {
                        const sideClass = order.side === 'buy' ? 'side-buy' : 'side-sell';
                        const sideText = order.side === 'buy' ? '매수' : '매도';
                        const typeText = order.order_type === 'market' ? '시장가' : '지정가';
                        const statusClass = `status-${order.status}`;
                        const statusText = {
                            'pending': '대기',
                            'filled': '체결',
                            'partial': '부분체결',
                            'cancelled': '취소'
                        }[order.status] || order.status;

                        return `
                            <tr>
                                <td>${formatDateTime(order.created_at)}</td>
                                <td>${order.code}</td>
                                <td class="${sideClass}">${sideText}</td>
                                <td>${typeText}</td>
                                <td style="text-align: right;">${order.price ? formatNumber(order.price) + '원' : '-'}</td>
                                <td style="text-align: right;">${formatQuantity(order.quantity)}</td>
                                <td style="text-align: right;">${order.filled_price ? formatNumber(order.filled_price) + '원' : '-'}</td>
                                <td style="text-align: right;">${formatQuantity(order.filled_quantity)}</td>
                                <td style="text-align: right;">${formatNumber(order.fee)}원</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            </tr>
                        `;
                    }).join('');
                }

                // Update pagination
                updatePagination('orders', ordersPage, ordersTotal, ordersLimit);

            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">주문 내역을 불러올 수 없습니다.</td></tr>';
            }
        }

        // Load trades
        async function loadTrades() {
            const tbody = document.getElementById('trades-body');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">로딩 중...</td></tr>';

            try {
                const data = await adminAPI.getParticipantTrades(participantId, {
                    limit: tradesLimit,
                    offset: tradesPage * tradesLimit
                });
                tradesTotal = data.total;

                if (data.trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">거래 내역이 없습니다.</td></tr>';
                } else {
                    tbody.innerHTML = data.trades.map(trade => {
                        const sideClass = trade.side === 'buy' ? 'side-buy' : 'side-sell';
                        const sideText = trade.side === 'buy' ? '매수' : '매도';

                        return `
                            <tr>
                                <td>${formatDateTime(trade.created_at)}</td>
                                <td>${trade.code}</td>
                                <td class="${sideClass}">${sideText}</td>
                                <td style="text-align: right;">${formatNumber(trade.price)}원</td>
                                <td style="text-align: right;">${formatQuantity(trade.quantity)}</td>
                                <td style="text-align: right;">${formatNumber(trade.total_amount)}원</td>
                                <td style="text-align: right;">${formatNumber(trade.fee)}원</td>
                            </tr>
                        `;
                    }).join('');
                }

                // Update pagination
                updatePagination('trades', tradesPage, tradesTotal, tradesLimit);

            } catch (error) {
                console.error('Error loading trades:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">거래 내역을 불러올 수 없습니다.</td></tr>';
            }
        }

        // Update pagination UI
        function updatePagination(type, page, total, limit) {
            const totalPages = Math.ceil(total / limit) || 1;
            const currentPage = page + 1;

            document.getElementById(`${type}-page-info`).textContent = `${currentPage} / ${totalPages}`;
            document.getElementById(`${type}-prev`).disabled = page === 0;
            document.getElementById(`${type}-next`).disabled = currentPage >= totalPages;
        }

        // Export trades to CSV
        function exportTrades() {
            alert('전체 거래 내역을 CSV로 다운로드하려면 API를 사용하세요.\n\nGET /api/admin/participants/' + participantId + '/trades?limit=500');
        }

        // Format helpers
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return Math.round(num).toLocaleString('ko-KR');
        }

        function formatQuantity(num) {
            if (num === null || num === undefined) return '-';
            if (num >= 1) return num.toFixed(4);
            return num.toFixed(8);
        }

        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('ko-KR', {
                timeZone: 'Asia/Seoul',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
    </script>
</body>
</html>
